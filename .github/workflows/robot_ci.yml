name: Run Robot Framework Tests on Local

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests with up to 2 retries (Windows)
        shell: pwsh
        run: |
          # Run 1
          robot --output output.xml --log log.html --report report.html Tests/
          $exit = $LASTEXITCODE

          if ($exit -ne 0) {
            Write-Host "Run 1 had failures ($exit). Rerunning failed tests (attempt 2/3)..."
            # Run 2 (retry 1)
            robot --rerunfailed output.xml --output rerun1.xml Tests/
            $exit = $LASTEXITCODE

            if ($exit -ne 0) {
              Write-Host "Run 2 still had failures ($exit). Rerunning failed tests (attempt 3/3)..."
              # Run 3 (retry 2)
              robot --rerunfailed rerun1.xml --output rerun2.xml Tests/
              $exit = $LASTEXITCODE
            }

            # Merge all available outputs and regenerate final log/report
            $mergeFiles = @("output.xml")
            if (Test-Path "rerun1.xml") { $mergeFiles += "rerun1.xml" }
            if (Test-Path "rerun2.xml") { $mergeFiles += "rerun2.xml" }

            rebot --merge --output output-merged.xml --log log.html --report report.html @mergeFiles
          }
          
          exit $exit

      - name: Upload merged test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robotframework-results
          path: |
            output.xml
            log.html
            report.html